# A reusable workflow for creating cross-platform release binaries/libraries

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      uploadRelease:
        required: false
        default: false
        type: boolean

jobs:
  build-for-release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        os: [linux, macos, windows]
        architecture: [x86_64, aarch64]
        include:
          - os: wasm
    steps:
      - uses: actions/checkout@v2
      - uses: goto-bus-stop/setup-zig@v1
        with:
          version: 0.9.1
      - run: |
          sudo apt-get update
          sudo apt install -y libcurl4-openssl-dev
      - name: Build target
        if: matrix.os != 'wasm'
        run: zig build -Dtarget=${{ matrix.architecture }}-${{ matrix.os }}
      - name: Build target
        if: matrix.os == 'wasm'
        run: zig build -Dwasm
      - name: Zip output executable
        if: matrix.os != 'wasm'
        run: zip -j fastfec-${{ matrix.os }}-${{ matrix.architecture }}-${{ inputs.version }}.zip zig-out/bin/fastfec
      - name: Get library output paths
        uses: kanga333/variable-mapper@master
        id: library
        with:
          key: "${{ matrix.os }}"
          map: |
            {
              "linux": {
                "ext": "so",
                "name": "libfastfec"
              },
              "mac": {
                "ext": "dylib",
                "name": "libfastfec"
              },
              "windows": {
                "ext": "dll",
                "name": "fastfec"
              },
              "wasm": {
                "ext": "wasm",
                "name": "fastfec"
              }
            }
          export_to: output
      - name: Move output library
        if: matrix.os != 'wasm'
        run: mv zig-out/lib/${{ steps.library.outputs.name }}.${{ steps.library.outputs.ext }} libfastfec-${{ matrix.os }}-${{ matrix.architecture }}-${{ inputs.version }}.${{ steps.library.outputs.ext }}
      - name: Move output library
        if: matrix.os == 'wasm'
        run: mv zig-out/lib/${{ steps.library.outputs.name }}.${{ steps.library.outputs.ext }} libfastfec-${{ inputs.version }}.${{ steps.library.outputs.ext }}
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        if: matrix.os != 'wasm'
        with:
          path: |
            fastfec-${{ matrix.os }}-${{ matrix.architecture }}-${{ inputs.version }}.zip
            libfastfec-${{ matrix.os }}-${{ matrix.architecture }}-${{ inputs.version }}.${{ steps.library.outputs.ext }}
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        if: matrix.os == 'wasm'
        with:
          path: |
            libfastfec-${{ inputs.version }}.${{ steps.library.outputs.ext }}
      - name: GitHub release
        uses: softprops/action-gh-release@v1
        if: inputs.uploadRelease && matrix.os != 'wasm'
        with:
          tag_name: ${{ inputs.version }}
          files: |
            fastfec-${{ matrix.os }}-${{ matrix.architecture }}-${{ inputs.version }}.zip
            libfastfec-${{ matrix.os }}-${{ matrix.architecture }}-${{ inputs.version }}.${{ steps.library.outputs.ext }}
      - name: GitHub release
        uses: softprops/action-gh-release@v1
        if: inputs.uploadRelease && matrix.os == 'wasm'
        with:
          tag_name: ${{ inputs.version }}
          files: |
            libfastfec-${{ inputs.version }}.${{ steps.library.outputs.ext }}
